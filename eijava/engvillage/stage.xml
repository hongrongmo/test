<project name="stage-engvillage" default="all" basedir=".">
	
	<property file="build.properties"/>
	<property name="stage.data.cluster" id="stageDataCluster" value="cv-test"/>
	<property name="stage.controller.cluster" id="stageControllerCluster" value="cv-test"/>
	<property name="stage.workdir" id="stageWorkDir" value="/export/home/engpub/working"/>
	<property name="stage.username" id="stageUsername" value="engpub"/>
	<property name="stage.password" id="stagePassword" value="2ep1111"/>
	
	<target name="all">
		<echo message="Moving the war files ......"/>
		<antcall target="stage-controller-move"/>
		<antcall target="stage-engresources-move"/>
		<antcall target="stage-engvillage-move"/>
		
		
		<echo message="Stopping the servers ......"/>
		<antcall target="stage-controller-stop"/>
		<antcall target="stage-engvillage-stop"/>


		<echo message="Moving the war files into position ......"/>
		<antcall target="stage-controller-position"/>
		<antcall target="stage-engvillage-position"/>
		<antcall target="stage-engresources-position"/>

		
		<echo message="Starting the servers ......." />
		<antcall target="stage-engvillage-start"/>
		<antcall target="stage-controller-start"/>
		

	</target>

	<target name="controller">
		<antcall target="stage-controller-move"/>
		<antcall target="stage-controller-stop"/>
		<antcall target="stage-controller-position"/>
		<sleep milliseconds="4000"/>
		<antcall target="stage-controller-start"/>
	</target>


	<target name="engresources">
		<antcall target="stage-engresources-move"/>
		<antcall target="stage-engresources-position"/>		
	</target>

	<target name="engvillage">
		<antcall target="stage-engvillage-move"/>
		<antcall target="stage-engvillage-stop"/>
		<antcall target="stage-engvillage-position"/>
		<sleep milliseconds="4000"/>
		<antcall target="stage-engvillage-start"/>
	</target>
	
	<target name="stage-controller-start">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStartController.setServer(clusterArray[i]);
				telnetStartController.setUserid(stageUsername.getValue());
				telnetStartController.setPassword(stagePassword.getValue());
				stageControllerStart.execute();
			}
			]]>

		</script>		
	</target>


	<target name="stage-controller-stop">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStopController.setServer(clusterArray[i]);
				telnetStopController.setUserid(stageUsername.getValue());
				telnetStopController.setPassword(stagePassword.getValue());
				stageControllerStop.execute();
			}
			]]>
		</script>		
	</target>

	<target name="stage-controller-position">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetPositionController.setServer(clusterArray[i]);
				telnetPositionController.setUserid(stageUsername.getValue());
				telnetPositionController.setPassword(stagePassword.getValue());
				stageControllerPosition.execute();
			}
			]]>

		</script>		
	</target>


	<target name="stage-ohubservice-position">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetPositionOHUBService.setServer(clusterArray[i]);
				telnetPositionOHUBService.setUserid(stageUsername.getValue());
				telnetPositionOHUBService.setPassword(stagePassword.getValue());
				stageOHUBServicePosition.execute();
			}
			]]>

		</script>		
	</target>
	
	<target name="stage-controller-move">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				ftpStageController.setServer(clusterArray[i]);
				ftpStageController.setUserid(stageUsername.getValue());
				ftpStageController.setPassword(stagePassword.getValue());
				ftpStageController.setRemotedir(stageWorkDir.getValue());
				stageControllerPut.execute();
			}

			]]>
		</script>		
	</target>

	

	<target name="stage-engresources-move">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				ftpStageEngResources.setServer(clusterArray[i]);
				ftpStageEngResources.setUserid(stageUsername.getValue());
				ftpStageEngResources.setPassword(stagePassword.getValue());
				ftpStageEngResources.setRemotedir(stageWorkDir.getValue());
				stageEngResourcesPut.execute();
			}
			]]>

		</script>	
	</target>


	<target name="stage-ohubservice-move">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				ftpStageOHUBService.setServer(clusterArray[i]);
				ftpStageOHUBService.setUserid(stageUsername.getValue());
				ftpStageOHUBService.setPassword(stagePassword.getValue());
				ftpStageOHUBService.setRemotedir(stageWorkDir.getValue());
				stageOHUBServicePut.execute();
			}
			]]>

		</script>	
	</target>

	<target name="stage-engresources-position">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageControllerCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetPositionEngResources.setServer(clusterArray[i]);
				telnetPositionEngResources.setUserid(stageUsername.getValue());
				telnetPositionEngResources.setPassword(stagePassword.getValue());
				stageEngResourcesPosition.execute();
			}
			]]>

		</script>		
	</target>	

	<target name="stage-engvillage-move">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				ftpStageEngVillage.setServer(clusterArray[i]);
				ftpStageEngVillage.setUserid(stageUsername.getValue());
				ftpStageEngVillage.setPassword(stagePassword.getValue());
				ftpStageEngVillage.setRemotedir(stageWorkDir.getValue());
				stageEngVillagePut.execute();
			}

			]]>
		</script>		
	</target>  


	<target name="stage-engvillage-start">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStartEngVillage.setServer(clusterArray[i]);
				telnetStartEngVillage.setUserid(stageUsername.getValue());
				telnetStartEngVillage.setPassword(stagePassword.getValue());
				stageEngVillageStart.execute();
			}
			]]>

		</script>		
	</target>

	<target name="stage-engvillage-stop">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStopEngVillage.setServer(clusterArray[i]);
				telnetStopEngVillage.setUserid(stageUsername.getValue());
				telnetStopEngVillage.setPassword(stagePassword.getValue());
				stageEngVillageStop.execute();
			}
			]]>
		</script>		
	</target>

	<target name="stage-engvillage-position">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetPositionEngVillage.setServer(clusterArray[i]);
				telnetPositionEngVillage.setUserid(stageUsername.getValue());
				telnetPositionEngVillage.setPassword(stagePassword.getValue());
				stageEngVillagePosition.execute();
			}
			]]>
		</script>		
	</target>




	<target name="stageControllerPut">
		<ftp 	id="ftpStageController"
			binary="yes">
			<fileset dir="controller/stage">
				<include name="controller.war"/>
			</fileset>
		</ftp>	
        </target>

	<target name="stageEngResourcesPut">
		<ftp 	id="ftpStageEngResources"
			binary="yes">
			<fileset dir="engresources/stage">
				<include name="engresources.war"/>
			</fileset>
		</ftp>	
        </target>


	<target name="stageEngVillagePut">
		<ftp 	id="ftpStageEngVillage"
			binary="yes">
			<fileset dir="engvillage/stage">
				<include name="engvillage.war"/>
			</fileset>
		</ftp>	
        </target>


	<target name="stageOHUBServicePut">
		<ftp 	id="ftpStageOHUBService"
			binary="yes">
			<fileset dir="ohubservice/stage">
				<include name="ohubservice.war"/>
			</fileset>
		</ftp>	
        </target>

	<target name="stageControllerStop">
		<telnet id="telnetStopController">
        		<write>source controller.env; echo Done</write>
        		<read>Done</read>
			<write>cd controller_appserver/bin; echo Done</write>
			<read>Done</read>
			<write>./shutdown.sh; echo Done</write>
			<read>Done</read>
     		</telnet>
	</target>

	



	<target name="stageControllerStart">
		<telnet id="telnetStartController">
        		<write>source controller.env; echo Done</write>
			<read>Done</read>
        		<write>cd controller_appserver/bin; echo Done</write>
			<read>Done</read>
			<write>rm ../logs/catalina.out; echo Done</write>
			<read>Done</read>
			<write>./startup.sh</write>
			<read timeout="10">Done</read>
			<write/>
			<write>sleep 15; echo Done</write>
			<read>Done</read>
			<write>cat ../logs/catalina.out; echo Done</write>
			<read>Done</read>
     		</telnet>
	</target>

	<target name="stageControllerPosition">
		<telnet id="telnetPositionController">
        		<write><![CDATA[rm -rf controller_appserver/webapps/controller* 2> /dev/null; echo Done]]></write>
			<read>Done</read>
			<write><![CDATA[mv working/controller.war controller_appserver/webapps 2> /dev/null; echo Done]]></write>
			<read>Done</read>
     		</telnet>
	</target>

	<target name="stageOHUBServicePosition">
		<telnet id="telnetPositionOHUBService">
        		<write><![CDATA[rm -rf controller_appserver/webapps/ohubservice* 2> /dev/null; echo Done]]></write>
			<read>Done</read>
			<write><![CDATA[mv working/ohubservice.war controller_appserver/webapps 2> /dev/null; echo Done]]></write>
			<read>Done</read>
     		</telnet>
	</target>


	<target name="stageEngVillagePosition">
		<telnet id="telnetPositionEngVillage">
        		<write><![CDATA[rm -rf data_appserver/webapps/engvillage* 2> /dev/null; echo Done]]></write>
			<read>Done</read>
			<write><![CDATA[mv working/engvillage.war data_appserver/webapps 2> /dev/null; echo Done]]></write>
			<read>Done</read>
     		</telnet>
	</target>

	<target name="stageEngResourcesPosition">
		<telnet id="telnetPositionEngResources">        		
			<write><![CDATA[mkdir working/engresources 2>> /dev/null; echo Done]]></write>
			<read>Done</read>
			<write>mv working/engresources.war working/engresources; echo Done</write>
			<read>Done</read>
			<write>cd working/engresources; echo Done</write>
			<read>Done</read>
			<write>jar -xf engresources.war; echo Done</write>
			<read>Done</read>
			<write>rm engresources.war; echo Done</write>
			<read>Done</read>
			<write>cd ..; echo Done</write>
			<read>Done</read>
			<write>cp -r engresources ../controller_appserver/webapps; echo Done</write>
			<read>Done</read>
			<write>rm -rf engresources; echo Done</write>
			<read>Done</read>
			<write>rm -rf ../controller_appserver/webapps/engresources/META-INF; echo Done</write>
			<read>Done</read>
			<write>rm  ../controller_appserver/webapps/engresources/engresources.war; echo Done</write>
     			<read>Done</read>
		</telnet>
	</target>


	<target name="stageEngVillageStart">
		<telnet id="telnetStartEngVillage">
        		<write>source data.env; echo Done</write>
			<read>Done</read>
        		<write>cd data_appserver/bin; echo Done</write>
			<read>Done</read>
			<write>rm ../logs/catalina.out; echo Done</write>
			<read>Done</read>
			<write>./startup.sh</write>
			<read timeout="10">Done</read>
			<write/>
			<write>sleep 30; echo Done</write>
			<read>Done</read>
			<write>cat ../logs/catalina.out; echo Done</write>
			<read>Done</read>
     		</telnet>
	</target>

	<target name="stageEngVillageStop">
		<telnet id="telnetStopEngVillage">
        		<write>source data.env; echo Done</write>
        		<read>Done</read>
			<write>cd data_appserver/bin; echo Done</write>
			<read>Done</read>
			<write>./shutdown.sh; echo Done</write>
			<read>Done</read>
     		</telnet>
	</target>
</project>
