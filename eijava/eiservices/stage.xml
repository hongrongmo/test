<project name="stage-eiservices" default="stage" basedir=".">
	
	<property file="build.properties"/>
	<property name="stage.data.cluster" id="stageDataCluster" value="cv-test"/>
	<property name="stage.workdir" id="stageWorkDir" value="/export/home/sespub/working"/>
	<property name="stage.username" id="stageUsername" value="sespub"/>
	<property name="stage.password" id="stagePassword" value="sinatra1"/>

	<property name="stage.logservice.workdir" id="stageLogServiceWorkDir" value="/export/home/logpub/working"/>
	<property name="stage.logservice.username" id="stageLogServiceUsername" value="logpub"/>
	<property name="stage.logservice.password" id="stageLogServicePassword" value="3ep1111"/>

	<target name="all">
		<echo message="Moving the war files ......"/>
		<antcall target="stage-sessionservice-move"/>
		<antcall target="stage-logservice-move"/>
		
		<echo message="Stopping the servers ......"/>
		<antcall target="stage-sessionservice-stop"/>
		<antcall target="stage-logservice-stop"/>
		
		<echo message="Moving the war files into position ......"/>		
		<antcall target="stage-sessionservice-position"/>
		<antcall target="stage-logservice-position"/>

		<echo message="Makeing sure the servers have had time to shutdown ....."/>
		<sleep milliseconds="4000"/>
		<echo message="Starting the servers ......." />
		<antcall target="stage-sessionservice-start"/>
		<antcall target="stage-logservice-start"/>
	</target>

	<target name="sessionservice">
		<antcall target="stage-sessionservice-move"/>
		<antcall target="stage-sessionservice-stop"/>
		<antcall target="stage-sessionservice-position"/>
		<sleep milliseconds="4000"/>
		<antcall target="stage-sessionservice-start"/>
	</target>

	<target name="logservice">
		<antcall target="stage-logservice-move"/>
		<antcall target="stage-logservice-stop"/>
		<antcall target="stage-logservice-position"/>
		<sleep milliseconds="4000"/>
		<antcall target="stage-logservice-start"/>
	</target>

	<target name="stage-sessionservice-move">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				ftpStageSessionService.setServer(clusterArray[i]);
				ftpStageSessionService.setUserid(stageUsername.getValue());
				ftpStageSessionService.setPassword(stagePassword.getValue());
				ftpStageSessionService.setRemotedir(stageWorkDir.getValue());
				stageSessionServicePut.execute();
			}

			]]>
		</script>		
	</target>


	<target name="stage-logservice-move">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				ftpStageLogService.setServer(clusterArray[i]);
				ftpStageLogService.setUserid(stageLogServiceUsername.getValue());
				ftpStageLogService.setPassword(stageLogServicePassword.getValue());
				ftpStageLogService.setRemotedir(stageLogServiceWorkDir.getValue());
				stageLogServicePut.execute();
			}

			]]>
		</script>		
	</target>


	<target name="stage-sessionservice-stop">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStopSessionService.setServer(clusterArray[i]);
				telnetStopSessionService.setUserid(stageUsername.getValue());
				telnetStopSessionService.setPassword(stagePassword.getValue());
				stageSessionServiceStop.execute();
			}
			]]>
		</script>		
	</target>

	<target name="stage-logservice-stop">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStopLogService.setServer(clusterArray[i]);
				telnetStopLogService.setUserid(stageLogServiceUsername.getValue());
				telnetStopLogService.setPassword(stageLogServicePassword.getValue());
				stageLogServiceStop.execute();
			}
			]]>
		</script>		
	</target>

	<target name="stage-sessionservice-position">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetPositionSessionService.setServer(clusterArray[i]);
				telnetPositionSessionService.setUserid(stageUsername.getValue());
				telnetPositionSessionService.setPassword(stagePassword.getValue());
				stageSessionServicePosition.execute();
			}
			]]>

		</script>		
	</target>

	<target name="stage-logservice-position">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetPositionLogService.setServer(clusterArray[i]);
				telnetPositionLogService.setUserid(stageLogServiceUsername.getValue());
				telnetPositionLogService.setPassword(stageLogServicePassword.getValue());
				stageLogServicePosition.execute();
			}
			]]>

		</script>		
	</target>

	<target name="stage-sessionservice-start">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStartSessionService.setServer(clusterArray[i]);
				telnetStartSessionService.setUserid(stageUsername.getValue());
				telnetStartSessionService.setPassword(stagePassword.getValue());
				stageSessionServiceStart.execute();
			}
			]]>

		</script>		
	</target>

	<target name="stage-logservice-start">
		<script language="javascript">
			<![CDATA[
			var theStrings = stageDataCluster.getValue();
			var clusterString = String(theStrings);
			var clusterArray  =  clusterString.split(",");
			for (var i=0; i < clusterArray.length; i++)
			{
				telnetStartLogService.setServer(clusterArray[i]);
				telnetStartLogService.setUserid(stageLogServiceUsername.getValue());
				telnetStartLogService.setPassword(stageLogServicePassword.getValue());
				stageLogServiceStart.execute();
			}
			]]>

		</script>		
	</target>


	<target name="stageSessionServicePut">
		<ftp 	id="ftpStageSessionService"
			binary="yes">
			<fileset dir="sessionservice/stage">
				<include name="sessionservice.war"/>
			</fileset>
		</ftp>	
        </target>

	<target name="stageLogServicePut">
		<ftp 	id="ftpStageLogService"
			binary="yes">
			<fileset dir="logservice/stage">
				<include name="logservice.war"/>
			</fileset>
		</ftp>	
        </target>


	<target name="stageSessionServiceStart">
		<telnet id="telnetStartSessionService">
        		<write>. sessionservice.env; echo Done</write>
			<read>Done</read>
        		<write>cd sessionservice_appserver/bin; echo Done</write>
			<write>./startup.sh</write>
			<read timeout="10">Done</read>
			<write/>
			<write>sleep 15; echo Done</write>
			<read>Done</read>
			<write>cat ../logs/catalina.out; echo Done</write>
			<read>Done</read>
			<write/>
     		</telnet>
	</target>

	<target name="stageLogServiceStart">
		<telnet id="telnetStartLogService">
        		<write>. log.env; echo Done</write>
			<read>Done</read>
        		<write>cd log_appserver/bin; echo Done</write>
			<write>./startup.sh</write>
			<read timeout="10">Starting Ajp12ConnectionHandler on 8091</read>
			<write/>
     		</telnet>
	</target>


	<target name="stageSessionServiceStop">
		<telnet id="telnetStopSessionService">
        		<write>. sessionservice.env; echo Done</write>
        		<read>Done</read>
			<write>cd sessionservice_appserver/bin; echo Done</write>
			<read>Done</read>
			<write>./shutdown.sh; echo Done</write>
			<read>Done</read>
     		</telnet>
	</target>

	<target name="stageLogServiceStop">
		<telnet id="telnetStopLogService">
        		<write>. log.env; echo Done</write>
        		<read>Done</read>
			<write>cd log_appserver/bin; echo Done</write>
			<read>Done</read>
			<write>./shutdown.sh; echo Done</write>
			<read>Done</read>
     		</telnet>
	</target>


	<target name="stageSessionServicePosition">
		<telnet id="telnetPositionSessionService">
        		<write><![CDATA[rm -rf sessionservice_appserver/webapps/sessionservice* 2> /dev/null; echo Done]]></write>
			<read>Done</read>
			<write><![CDATA[mv working/sessionservice.war sessionservice_appserver/webapps 2> /dev/null; echo Done]]></write>
			<read>Done</read>
     		</telnet>
	</target>


	<target name="stageLogServicePosition">
		<telnet id="telnetPositionLogService">
        		<write><![CDATA[rm -rf log_appserver/webapps/logservice* 2> /dev/null; echo Done]]></write>
			<read>Done</read>
			<write><![CDATA[mv working/logservice.war log_appserver/webapps 2> /dev/null; echo Done]]></write>
			<read>Done</read>
     		</telnet>
	</target>
</project>
