<project name="Webapp Precompilation" basedir=".."  default="all">

    <property environment="env" />

    <target name="tomcat_check" unless="env.CATALINA_HOME">
        <echo message="FAILURE!! YOU MUST SET CATALINA_HOME ENVIRONMENT VARIABLE to the location of your tomcat install!"/>
        <fail message="FAILURE!! i.e. set CATALINA_HOME=C:\\tomcat-7 !"/>
    </target>

    <property name="tomcat.home" value="${env.CATALINA_HOME}"/>
    <property name="webapp.path" value="${env.CATALINA_HOME}/webapps/emetrics"/>

  	<target name="clean">
    	<delete dir="${webapp.path}/WEB-INF/src"/>
    	<delete file="${webapp.path}/WEB-INF/generated_web.xml"/>
  	</target>

    <target name="jspc" unless="tomcat_check">

		<echo message="echo tomcat ${tomcat.home}"/>

    <taskdef classname="org.apache.jasper.JspC" name="jasper2" >
      <classpath id="jspc.classpath">
        <pathelement location="${java.home}../lib/tools.jar"/>
        <fileset dir="${tomcat.home}/bin">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${tomcat.home}/server/lib">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${tomcat.home}/common/lib">
          <include name="*.jar"/>
        </fileset>
      </classpath>
    </taskdef>

    <jasper2
             validateXml="false"
             uriroot="${webapp.path}"
             webXmlFragment="${webapp.path}/WEB-INF/generated_web.xml"
             outputDir="${webapp.path}/WEB-INF/src" />

  </target>


  <target name="compile">

    <mkdir dir="${webapp.path}/WEB-INF/classes"/>
    <mkdir dir="${webapp.path}/WEB-INF/lib"/>

    <javac destdir="${webapp.path}/WEB-INF/classes"
           optimize="off"
           debug="on" failonerror="false"
           srcdir="${webapp.path}/WEB-INF/src"
	   excludes="**/*.smap">
      <classpath>
        <pathelement location="${webapp.path}/WEB-INF/classes"/>
        <fileset dir="${webapp.path}/WEB-INF/lib">
          <include name="*.jar"/>
        </fileset>
       <pathelement location="${tomcat.home}/classes"/>
        <fileset dir="${tomcat.home}/lib">
          <include name="*.jar"/>
        </fileset>
        <pathelement location="${tomcat.home}/common/classes"/>
        <fileset dir="${tomcat.home}/common/lib">
          <include name="*.jar"/>
        </fileset>
        <pathelement location="${tomcat.home}/shared/classes"/>
        <fileset dir="${tomcat.home}/shared/lib">
          <include name="*.jar"/>
        </fileset>
 
        </classpath>
      <include name="**" />
      <!-- excluded (dead/devel) files -->
      <exclude name="**/reports/**.java" />
    </javac>

  </target>

  <target name="all" depends="jspc,compile">
  </target>


	<target name="ver">
	  	<tstamp>
			<format property="TODAY" pattern="MM/dd/yyyy hh:mm:ss a" locale="en"/>
			<format property="DSTAMP" pattern="MM.dd.yyyy" locale="en"/>
			<format property="TSTAMP" pattern="HH.mm.ss.S" locale="en"/>
	  	</tstamp>

		<echo message="Now: ${TODAY}"/>
		<echo message=""/>
		<echo message="Ant Version ${ant.version}"/>
		<echo message="OS ${os.name} Version ${os.version}"/>
		<echo message="User ${user.name}"/>
		<echo message="Java VM ${java.vendor} Version ${java.vm.version}"/>
		<echo message="Java Home ${java.home}"/>
		<echo message=""/>
		<echo message="Project: ${ant.project.name}"/>
		<echo message="Base Directory: ${basedir}"/>
		<echo message="Buildfile: ${ant.file}"/>

	</target>

</project>

