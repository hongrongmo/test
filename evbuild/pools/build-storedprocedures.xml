<project name="storedprocedures" default="usage" basedir=".">

	<!-- this env can be overridden on the command line with -Denv=<value> -->
	<property name="properties" value="dev"/>

	<property name="dir.eijava-root" value=".."/>
	<property name="dir.eilib-jars" value="${dir.eijava-root}/dist" />
	<property name="dir.ext-jars" value="${dir.eijava-root}/ext" />
	<property name="dir.englib-jars" value="${dir.eijava-root}/engvillage/englib" />
	<property name="dir.engvillage-project" value="${dir.eijava-root}/engvillage" />

	<property name="test-dir" value="./test" />
	<property name="logs-dir" value="${test-dir}/logs/" />
	<property name="lib-dir" value="${test-dir}/lib/" />

	<fileset id="ext-jars" dir="${dir.ext-jars}">
		<include name="**/*.jar"/>
		<exclude name="**/JDBCLog.jar"/>
		<exclude name="**/HTTPClient.jar"/>
		<exclude name="**/webserver.jar"/>
	</fileset>
	<fileset id="eilib-jars" dir="${dir.eilib-jars}">
		<include name="**/eilib.jar"/>
	</fileset>
	<fileset id="englib-jars" dir="${dir.englib-jars}">
		<include name="**/englib.jar"/>
	</fileset>

	<fileset id="local-jars" dir="${lib-dir}">
		<include name="**/*.jar"/>
	</fileset>

	<path id="project.class.path">
    <fileset refid="local-jars" />
	</path>

	<target name="config" depends="libs">
    <mkdir dir="${test-dir}"/>
    <mkdir dir="${logs-dir}"/>
    <mkdir dir="${lib-dir}"/>

		<echo message="Settings/Environment file is ${properties}.properties"/>
		<!-- Configure the emailalert.properties, emailalert_pool.xml -->
    <filter filtersfile="./${properties}.properties"/>

    <filter token="appserver.logs" value="${logs-dir}"/>

    <!-- Configure the Database Pools -->
		<copy overwrite="yes" file="./engvillage/etc/pools.xml" tofile="${logs-dir}/pools.xml" filtering="yes"/>

	</target>

	<target name="libs" >
		<copy todir="${lib-dir}" flatten="yes">
			<fileset refid="ext-jars"/>
			<fileset refid="englib-jars"/>
			<fileset refid="eilib-jars"/>
		</copy>
	</target>

	<target name="dist" depends="libs">
		<echo message="Done copying files from EV2 project tree into local emailalerts subproject..."/>
	</target>

	<target name="run" depends="ver,config" >

		<echo message="Testing Procedures"/> <!-- Output is being redirected to ${logs-dir}/testprocs_${DSTAMP}_${TSTAMP}.txt"/-->

		<java classname="org.ei.util.TestProcedure" fork="yes" > <!-- output="${logs-dir}/testprocs_${DSTAMP}_${TSTAMP}.txt"-->
			<classpath refid="project.class.path"/>
		</java>

    <antcall target="cleanup"/>

	</target>

	<target name="cleanup" depends="" >

		<delete>
<!--			<fileset dir="${logs-dir}" includes="**/*.log"/> -->
			<fileset dir="${logs-dir}" includes="**/*.logpid"/>
		</delete>

		<delete file="${logs-dir}/pools.xml" />
		<delete >
      <fileset refid="local-jars"/>
		</delete >
  </target>

	<target name="usage" depends="ver">
		<echo message="config target prepares local subproject by refreshing jars from EV2 source tree."/>
		<echo message="run target sets specified environment properties [Default is dev] and runs tests."/>
	</target>

	<target name="ver">
  	<tstamp>
  		<format property="TODAY" pattern="MM/dd/yyyy hh:mm:ss a" locale="en"/>
  		<format property="DSTAMP" pattern="MM.dd.yyyy" locale="en"/>
  		<format property="TSTAMP" pattern="HH.mm.ss.S" locale="en"/>
  	</tstamp>

		<echo message="Now: ${TODAY}"/>
		<echo message=""/>
		<echo message="Ant Version ${ant.version}"/>
		<echo message="OS ${os.name} Version ${os.version}"/>
		<echo message="User ${user.name}"/>
		<echo message="Java VM ${java.vendor} Version ${java.vm.version}"/>
		<echo message="Java Home ${java.home}"/>
		<echo message=""/>
		<echo message="Project: ${ant.project.name}"/>
		<echo message="Base Directory: ${basedir}"/>
		<echo message="Buildfile: ${ant.file}"/>
	</target>

</project>

