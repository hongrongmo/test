<!--
****************************************************************************
Copy blocked_ips.txt file to all PROD appservers and bounce
****************************************************************************
-->
<project name="blockips" default="blockips.prod" basedir=".">
	<property environment="env" />
	<property name="blocked.ip.path" value="C:\dev\ws\evweb\ROOT\resources\"/>
	
	<!-- *************************************************************** -->
	<!-- SCP from build directory -->
	<!-- *************************************************************** -->
	<target name="init">
		<condition property="blocked.ip.file.available">
			<available file="${blocked.ip.path}\blocked_ip.txt"/>
		</condition>
	</target>

	<!-- Ant Tomcat tasks -->
	<path id="catalina-ant-classpath">
		<!-- We need the Catalina jars for Tomcat -->
		<!--  * for other app servers - check the docs -->
		<fileset dir="${env.CATALINA_HOME}/lib">
			<include name="catalina-ant.jar" />
			<include name="tomcat-coyote.jar" />
			<include name="tomcat-util.jar" />
		</fileset>
		<fileset dir="${env.CATALINA_HOME}/bin">
			<include name="tomcat-juli.jar" />
		</fileset>
	</path>
	<taskdef name="list" classname="org.apache.catalina.ant.ListTask" classpathref="catalina-ant-classpath" />
	<taskdef name="reload" classname="org.apache.catalina.ant.ReloadTask" classpathref="catalina-ant-classpath" />
	<taskdef name="resources" classname="org.apache.catalina.ant.ResourcesTask" classpathref="catalina-ant-classpath" />
	<taskdef name="start" classname="org.apache.catalina.ant.StartTask" classpathref="catalina-ant-classpath" />
	<taskdef name="stop" classname="org.apache.catalina.ant.StopTask" classpathref="catalina-ant-classpath" />
	<taskdef name="undeploy" classname="org.apache.catalina.ant.UndeployTask" classpathref="catalina-ant-classpath" />
	<taskdef name="deploy" classname="org.apache.catalina.ant.DeployTask" classpathref="catalina-ant-classpath" />

	<!-- *************************************************************** -->
	<!-- Copy local blocked_ip.txt file to cpc1797 -->
	<!-- *************************************************************** -->
	<target name="blockips.cpc1797" depends="init">
		<fail unless="blocked.ip.file.available" message="Could not find file at: '${blocked.ip.path}\blocked_ip.txt'"/>
		
		<property name="tomcat.username" value="admin" />
		<property name="tomcat.password" value="NSt6Paoo" />

		<echo>[evbuild setup] Copying ${blocked.ip.path}\blocked_ip.txt to cpc1797...</echo>
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@cpc1797:~/evweb_appserver/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_cert_openssh.rsa" trust="true" passphrase="" />
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@cpc1797:~/evweb_appserver2/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_cert_openssh.rsa" trust="true" passphrase="" />
		<echo>[blockips cpc1797] Restarting ROOT on evweb_appserver...</echo>
		<antcall target="restartROOT">
			<param name="restart.url" value="http://cpc1797:25331/manager/text"/>
		</antcall>
		<echo>[blockips cpc1797] Restarting ROOT on evweb_appserver2...</echo>
		<antcall target="restartROOT">
			<param name="restart.url" value="http://cpc1797:25332/manager/text"/>
		</antcall>
	</target>

	<!-- *************************************************************** -->
	<!-- Copy local blocked_ip.txt file to all PROD appservers -->
	<!-- *************************************************************** -->
	<target name="blockips.prod" depends="init">
		<fail unless="blocked.ip.file.available" message="Could not find file at: '${blocked.ip.path}\blocked_ip.txt'"/>

		<property name="tomcat.username" value="admin" />
		<property name="tomcat.password" value="NSt6Paoo" />

		<echo>[blockips PROD] Copying ${blocked.ip.path}\blocked_ip.txt to psc1970...</echo>
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1970:~/evweb_appserver/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1970:~/evweb_appserver2/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<echo>[blockips PROD] Restarting ROOT on evweb_appserver...</echo>
		<!--
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1970:25330/manager/text"/>
		</antcall>
		<echo>[blockips PROD] Restarting ROOT on evweb_appserver2...</echo>
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1970:25329/manager/text"/>
		</antcall>
		-->
		
		<echo>[evbuild setup] Copying ${blocked.ip.path}\blocked_ip.txt to psc1971...</echo>
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1971:~/evweb_appserver/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1971:~/evweb_appserver2/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<!--
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1971:25330/manager/text"/>
		</antcall>
		<echo>[blockips PROD] Restarting ROOT on evweb_appserver2...</echo>
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1971:25329/manager/text"/>
		</antcall>
		-->

		<echo>[evbuild setup] Copying ${blocked.ip.path}\blocked_ip.txt to psc1972...</echo>
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1972:~/evweb_appserver/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1972:~/evweb_appserver2/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<!--
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1972:25330/manager/text"/>
		</antcall>
		<echo>[blockips PROD] Restarting ROOT on evweb_appserver2...</echo>
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1972:25329/manager/text"/>
		</antcall>
		-->

		<echo>[evbuild setup] Copying ${blocked.ip.path}\blocked_ip.txt to psc1973...</echo>
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1973:~/evweb_appserver/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<scp file="${blocked.ip.path}\blocked_ip.txt" todir="u1engpub@psc1973:~/evweb_appserver2/webapps/ROOT/WEB-INF/classes/." keyfile="${user.home}/ssh/ev_prod_openssh.rsa" trust="true" passphrase="" />
		<!--
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1973:25330/manager/text"/>
		</antcall>
		<echo>[blockips PROD] Restarting ROOT on evweb_appserver2...</echo>
		<antcall target="restartROOT">
			<param name="restart.url" value="http://psc1973:25329/manager/text"/>
		</antcall>
		-->

	</target>

	<!-- *************************************************************** -->
	<!-- Restart ROOT (both appservers) -->
	<!-- *************************************************************** -->
	<target name="restartROOT">
		<echo>[blockips restartROOT] Checking properties:  ${tomcat.username}, ${tomcat.password}, ${restart.url}</echo>
		<fail unless="tomcat.username" message="Property 'tomcat.username' must be set!" />
		<fail unless="tomcat.password" message="Property 'tomcat.password' must be set!" />
		<fail unless="restart.url" message="Property 'restart.url' must be set!" />

		<echo>[blockips restartROOT] Restarting ${restart.url}, ROOT app...</echo>
		<stop url="${restart.url}" username="${tomcat.username}" password="${tomcat.password}" path="/" />
		<start url="${restart.url}" username="${tomcat.username}" password="${tomcat.password}" path="/" />
		<echo>[blockips restartROOT] Done restarting ${restart.url}!</echo>
	</target>
</project>